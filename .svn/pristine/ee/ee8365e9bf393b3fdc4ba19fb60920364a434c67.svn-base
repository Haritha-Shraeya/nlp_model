from os.path import exists
from docx import Document
from pandas import read_excel
from PIL import Image
from pdf2image import convert_from_path
from pptx import Presentation
from pytesseract import pytesseract


class OCRHandler(object):

    def run_handle(self, file_path: str, file_type: str):
        if file_type == "pdf":
            text = self.pdf(file_path=file_path)
        elif file_type == "png":
            text = self.png(file_path=file_path)
        elif file_type == "jpeg":
            text = self.jpeg(file_path=file_path)
        elif file_type == "pptx":
            text = self.pptx(file_path=file_path)
        elif file_type == "jpg":
            text = self.jpg(file_path=file_path)
        elif file_type == "docx":
            text = self.docx(file_path=file_path)
        elif file_type == "xlsx":
            text = self.xlsx(file_path=file_path)
        elif file_type == "gif":
            text = self.gif(file_path=file_path)
        else:
            print("Cannot process file type")
            text = "File type cannot be processed"
        return text

    def pdf(self, file_path):
        text = ""
        try:
            images = convert_from_path(file_path)
            for image in images:
                text = text + pytesseract.image_to_string(image)
            return text
        except:
            return "file/file-path not found"

    def png(self, file_path):
        try:
            img = Image.open(file_path)
            text = pytesseract.image_to_string(img)
            img.close()
            return text
        except:
            return "file/file-path not found"

    def jpeg(self, file_path):
        try:
            img = Image.open(file_path)
            text = pytesseract.image_to_string(img)
            img.close()
            return text
        except:
            return "file/file-path not found"

    def pptx(self, file_path):
       text = ""
       try:
           ppt = Presentation(file_path)
           for slide in ppt.slides:
               for shape in slide.shapes:
                   if hasattr(shape, "text"):
                       text = text + " " + shape.text
           return text
       except:
           return "file/file-path not found"

    def jpg(self, file_path):
        try:
            img = Image.open(file_path)
            text = pytesseract.image_to_string(img)
            img.close()
            return text
        except:
            return "file/file-path not found"

    def docx(self, file_path):
        text = ""
        try:
            doc = Document(file_path)
            for para in doc.paragraphs:
                text = text + para.text
            return text
        except:
            return "file/file-path not found"

    def xlsx(self, file_path):
        text = ""
        try:
            df = read_excel(file_path)
            for i in range(0, df.shape[0]): # to access row
                for j in range(0, df.shape[1]): # to access each field in row
                    text = text + " " + str(df.iloc[i][j])
            return text
        except:
            return "file/file-path not found"

    def gif(self, file_path):
        try:
            img = Image.open(file_path)
            text = pytesseract.image_to_string(img)
            img.close()
            return text
        except:
            return "file/file-path not found"

