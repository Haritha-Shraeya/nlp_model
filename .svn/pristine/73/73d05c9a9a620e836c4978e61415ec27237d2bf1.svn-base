from flask import Flask, request, jsonify, make_response
from datetime import datetime
from model_builder.modelBuild import ModelBuilderHandle
from model_store.controller.challenge_schema import ChallengeInput
from marshmallow import ValidationError
from model_store.persistency.persistency import Challenge_esi
from model_store.controller.challenge_schema import ChallengeInput, GetChallenge

import requests as req
from ocr_module.OCRhandler import OCRHandler
from ocr_module.ElasticSearchHandler import ElasticSearchHandle

import os

app = Flask(__name__)

mbh = ModelBuilderHandle()
CSVfile = "C:\\Users\\user1\\SearchEngine\\repository\\data\\ChallengeData.csv"

c_esi = Challenge_esi()

esh = ElasticSearchHandle()
ocr = OCRHandler()

@app.route('/')
def index():
    return 'Hello World'

@app.route('/buildmodel', methods = ["GET"])    
def buildmodel():
    text = mbh.textProcessor(csv_file = CSVfile)
    print('got text')

    _count_vect, _tfidf_transformer, _train_tfidf = mbh.build_model(text = text)
    
    return ('processed successfully')
     
@app.route('/insertes', methods = ["POST"])    
def insert_es(): 
    #posted data in json format
    request_json = request.json
    try:
        #deserializing json request data
        data = ChallengeInput().load(request_json)
        #extracting challenge_id, challenge_title and text from posted data
        #challenge_id, challenge_title, text = data['challenge_id'], data['challenge_title'], data['text']
    except ValidationError as err: #in the case of incompatible parameters in data posted
        return jsonify(err.messages), 400   #response object and status code

    #insert into elastic search 
    #try:
    print(data)
    response = c_esi.insert_update_challenge(data)
    print(type(response))
    return jsonify(response), 200 #response object and status code

    # except Exception as err:
    #     print(err)
    #     return "Insert/Update unsuccessful"


@app.route('/getChallenge')
def get_challenge():
    request_data = request.args
    schema = GetChallenge()
    try:
        data = schema.load(request_data)
        challenge_id = data['challenge_id']
        print(challenge_id)

    except ValidationError as err:
        print("validation error")
        return jsonify(err.messages), 400

    try:
        response_data = c_esi.get_challenge(challenge_id=challenge_id)
        return jsonify(response_data), 200
    except Exception as err:
        return jsonify({'error: ': err}), 500

@app.route('/getAllChallenges', methods=["GET"])
def get_all_challenges():
    try:
        response_data = c_esi.get_all_challenges()
        return (response_data), 200
    except Exception as err:
        return jsonify({'error: ': err}), 500

@app.route("/update", methods=['POST'])
def update():
    timeobj = datetime.utcnow()
    timestr = timeobj.strftime("%Y%m%d%H%M%S%f")

    request_data = request.json
    request_keys = request_data.keys()

    desc_vars = ["submission_type", "challenge_id", "challenge_title", "text", "attachments", "buildmodel"]
    # descriptor variables
    att_vars = [x for x in request_keys if
                x not in desc_vars]  # storing attachment names

    try:
        sub_type = request_data["submission_type"]
    except:
        return jsonify({'Message:': "Please enter submission type or check submission_type parameter name"}), 404

    desc_dict = dict()  # stores descriptor information related to challenge/idea/solution
    desc_dict["submission_type"] = sub_type
    desc_dict["timestamp"] = timestr

    if sub_type == "challenge":

        try:
            desc_dict["challenge_id"] = request_data["challenge_id"]
        except:
            return jsonify({'Message:': "Please enter challenge id or check challenge_id parameter name"}), 404

        try:
            desc_dict["challenge_title"] = request_data["challenge_title"]
        except:
            return jsonify({'Message:': "Please enter challenge title or check challenge_title parameter name"}), 404

    try:
        desc_dict["text"] = request_data["text"]
    except:
        return jsonify({'Message:': "Please enter text or check text prameter name"}), 404

    if "text" in request_keys:
        _text = request_data["text"] + " "
    else:
        _text = ""



    for attachment in att_vars:
        doc_url = request_data[attachment]
        doc = req.get(doc_url)

    # Extracting text from attached files
    try:
        json_object = request_data["attachments"]
        attachments = True
        for key in json_object:
            value = json_object[key]
            r = req.get(value, allow_redirects=True)
            file_name = value.split("/")[-1].lower()
            file_type = file_name.split(".")[-1].lower()
            file_name = file_name.removeprefix("view?attachmentid=")
            file_path = os.getcwd() + os.sep + "temp/" + file_name

            with open(file_path, "wb") as file:
                file.write(r.content)

            try:
                _text = _text + ocr.run_handle(file_path=file_path, file_type="pdf")
            except Exception as e:
                print(e)
                _text = "Error: unable to load file"
    except:
        attachments = False
        _text = "No attachments"

    # storing extracted data in elastic search
    try:
        esh.store_extracted_text(_text, desc_dict)
        return "extracted text stored successfully"
    except:
        return "Operation unsuccessful"


if __name__ == "__main__":
    app.run(debug=True)    
    